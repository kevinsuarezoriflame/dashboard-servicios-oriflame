<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oriflame | Dashboard de Servicios</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --of-green-900:#0b3d2e;
      --of-green-700:#146a4a;
      --of-green-200:#dff3ea;
      --of-mint:#eaf7f1;
      --of-gold:#c9a227;
      --of-ink:#0f172a;
      --of-muted:#64748b;
      --of-border:#e5e7eb;
      --of-white:#ffffff;
      --shadow-soft: 0 6px 18px rgba(2,6,23,.06);
      --radius: 16px;
      --topbar-h: 0px;

      --cat-orange:#f28b2c;
      --cat-orange-2:#ffb36a;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--of-ink);
      background: linear-gradient(180deg, var(--of-mint), #fff);
    }

    .topbar{
      position:sticky; top:0; z-index:20;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--of-border);
    }
    .topbar-inner{
      max-width: 1240px;
      margin: 0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      gap:14px;
      justify-content:space-between;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:40px; height:40px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, var(--of-green-700), var(--of-green-900));
      box-shadow: var(--shadow-soft);
      position:relative;
      flex: 0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset:11px 12px 11px 12px;
      border-radius: 10px;
      border: 2px solid rgba(201,162,39,.75);
    }
    .brand h1{
      font-size: 14px; margin:0; line-height:1.15;
      letter-spacing:.2px;
      font-weight:900;
    }
    .brand .sub{
      font-size:12px; color: var(--of-muted);
      margin-top:2px;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border: 1px solid var(--of-border);
      background: var(--of-white);
      border-radius: 999px;
      box-shadow: 0 2px 10px rgba(2,6,23,.04);
      max-width: 100%;
    }
    .pill label{
      font-size:12px; color: var(--of-muted);
      white-space:nowrap;
      font-weight:700;
    }
    .pill input[type="file"]{
      font-size:12px;
      max-width: 380px;
    }
    select{
      border: 1px solid var(--of-border);
      border-radius: 10px;
      padding: 7px 10px;
      outline:none;
      background: #fff;
      font-size:12px;
      max-width: 280px;
    }
    .btn{
      border: 1px solid rgba(20,106,74,.25);
      background: linear-gradient(180deg, var(--of-green-700), var(--of-green-900));
      color:#fff;
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:900;
      box-shadow: var(--shadow-soft);
      font-size: 12px;
      white-space:nowrap;
    }
    .btn.secondary{
      background:#fff;
      color: var(--of-green-900);
      border:1px solid var(--of-border);
      box-shadow:none;
      font-weight:900;
    }
    .btn.danger{
      background:#fff;
      color: var(--danger);
      border:1px solid rgba(198,40,40,.35);
      box-shadow:none;
      font-weight:900;
    }
    .btn.danger:hover{ filter:brightness(.98); }

    .btn:active{ transform: translateY(1px); }

    .catbar-wrap{
      position:sticky;
      top: var(--topbar-h, 0px);
      z-index:19;
      border-bottom: 1px solid var(--of-border);
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.82));
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 22px rgba(2,6,23,.05);
    }
    .catbar{
      max-width: 1240px;
      margin: 0 auto;
      padding: 10px 18px 12px;
    }
    .catbar-topline{
      height: 14px;
      border-radius: 10px;
      background: linear-gradient(90deg, #ff5a1f, var(--cat-orange));
      margin-bottom: 10px;
      opacity: .95;
    }

    .year-tabs{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      margin: 2px 0 10px;
    }
    .year-btn{
      border: 1px solid rgba(11,61,46,.18);
      background: rgba(255,255,255,.95);
      color: var(--of-green-900);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
      cursor: pointer;
      box-shadow: var(--shadow-soft);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .year-btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(2,6,23,.08); }
    .year-btn.active{
      background: linear-gradient(135deg, var(--of-green-700), var(--of-green-900));
      color: #fff;
      border-color: rgba(11,61,46,.45);
    }

    .cat-tabs{
      display:flex;
      gap: 18px;
      flex-wrap: wrap;
      align-items:center;
    }
    .cat-btn{
      border: none;
      cursor:pointer;
      padding: 10px 18px;
      border-radius: 12px;
      background: linear-gradient(180deg, var(--cat-orange-2), var(--cat-orange));
      color: #ffffff;
      font-weight:900;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(217,106,9,.18);
      transition: transform .06s ease, filter .12s ease, opacity .12s ease;
      max-width: 100%;
      position: relative;
    }
    .cat-btn:hover{ filter: brightness(1.02); }
    .cat-btn:active{ transform: translateY(1px); }
    .cat-btn.active{
      outline: 3px solid rgba(201,162,39,.35);
      filter: saturate(1.05);
    }
    .cat-btn.all{
      background: linear-gradient(180deg, rgba(20,106,74,.95), rgba(11,61,46,.98));
      box-shadow: 0 4px 12px rgba(11,61,46,.18);
    }
    .cat-count{
      margin-left: 10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 26px;
      height: 20px;
      padding: 0 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.22);
      border: 1px solid rgba(255,255,255,.25);
      font-size: 12px;
      font-weight: 900;
    }

    .container{
      max-width: 1240px;
      margin: 16px auto 40px;
      padding: 0 18px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-top: 14px;
    }

    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--of-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    .card-header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--of-border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
    }
    .card-title{
      margin:0;
      font-size: 13px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .card-sub{
      margin-top:4px;
      font-size: 12px;
      color: var(--of-muted);
    }
    .card-body{ padding: 14px 16px; }

    .badge{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--of-green-200);
      color: var(--of-green-900);
      border: 1px solid rgba(20,106,74,.20);
      white-space:nowrap;
      max-width: 360px;
      overflow:hidden;
      text-overflow: ellipsis;
      font-weight:800;
    }
    .badge.gold{
      background: rgba(201,162,39,.12);
      border-color: rgba(201,162,39,.25);
      color: #6b4e00;
    }
    .badge.red{
      background: rgba(239,68,68,.10);
      border-color: rgba(239,68,68,.22);
      color: #991b1b;
    }

    .kpi .value{
      font-size: 22px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .kpi .hint{
      font-size: 12px;
      color: var(--of-muted);
      margin-top: 4px;
    }

    .span-3{ grid-column: span 3; }
    .span-6{ grid-column: span 6; }
    .span-12{ grid-column: span 12; }

    @media (max-width: 980px){
      .span-3, .span-6{ grid-column: span 12; }
      .controls{ justify-content:flex-start; }
      .pill input[type="file"]{ max-width: 280px; }
      .cat-tabs{ gap: 10px; }
      .cat-btn{ font-size: 13px; padding: 9px 14px; }
    }

    .table-wrap{
      overflow:auto;
      border:1px solid var(--of-border);
      border-radius: 14px;
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 1040px;
      background:#fff;
    }
    th, td{
      padding: 10px 12px;
      border-bottom: 1px solid var(--of-border);
      font-size: 12px;
      text-align:left;
      vertical-align: top;
    }
    th{
      position:sticky; top:0;
      background: linear-gradient(180deg, rgba(11,61,46,.08), rgba(11,61,46,.02));
      color: var(--of-green-900);
      font-weight:900;
      z-index:1;
    }
    td.num{ text-align:right; font-variant-numeric: tabular-nums; }

    .empty{
      padding: 18px;
      border: 1px dashed rgba(20,106,74,.35);
      border-radius: var(--radius);
      background: rgba(223,243,234,.45);
      color: var(--of-green-900);
      font-weight:900;
    }

    details.uploads{
      border: 1px solid var(--of-border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    details.uploads summary{
      list-style: none;
      cursor:pointer;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      user-select:none;
    }
    details.uploads summary::-webkit-details-marker{ display:none; }
    .uploads-title{
      display:flex; align-items:center; gap:10px;
      font-weight: 900;
      font-size: 13px;
    }
    .chev{
      width: 10px; height: 10px;
      border-right: 2px solid var(--of-muted);
      border-bottom: 2px solid var(--of-muted);
      transform: rotate(-45deg);
      transition: transform .14s ease;
      margin-left: 6px;
    }
    details[open] .chev{ transform: rotate(45deg); }

    .uploads-body{
      border-top: 1px solid var(--of-border);
      padding: 12px 14px 14px;
    }
    .uploads-table{
      width:100%;
      border-collapse: collapse;
      background:#fff;
      border: 1px solid var(--of-border);
      border-radius: 14px;
      overflow:hidden;
    }
    .uploads-table th, .uploads-table td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--of-border);
      font-size: 12px;
    }
    .uploads-table th{
      background: rgba(11,61,46,.04);
      color: var(--of-green-900);
      font-weight: 900;
      text-align:left;
    }
    .uploads-table td.num{ text-align:right; }
    .mini-btn{
      border: 1px solid var(--of-border);
      background:#fff;
      color: #b91c1c;
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
    }
    .mini-btn:hover{ background: rgba(185,28,28,.06); }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 50;
      max-width: 620px;
      display:none;
      gap: 10px;
      align-items:flex-start;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(185,28,28,.20);
      background: rgba(255,255,255,.96);
      box-shadow: var(--shadow-soft);
    }
    .toast strong{ display:block; font-size: 12px; font-weight: 900; color: #991b1b; }
    .toast span{ display:block; font-size: 12px; color: var(--of-muted); margin-top:2px; white-space: pre-wrap; }
    .toast button{
      margin-left:auto;
      border:1px solid var(--of-border);
      background:#fff;
      border-radius: 10px;
      padding: 6px 10px;
      cursor:pointer;
      font-weight: 900;
      color: var(--of-green-900);
    }

    .progress-pill{
      display:none;
      align-items:center;
      gap:10px;
      margin-top: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(201,162,39,.25);
      background: rgba(201,162,39,.10);
      border-radius: 14px;
      font-weight: 900;
      color: #6b4e00;
    }
    .progress-bar{
      flex: 1 1 auto;
      height: 10px;
      border-radius: 999px;
      background: rgba(2,6,23,.06);
      overflow:hidden;
    }
    .progress-bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(20,106,74,.9), rgba(11,61,46,1));
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Dashboard de Servicios</h1>
          <div class="sub">Oriflame Ec</div>
        </div>
      </div>

      <div class="controls">
        <div class="pill" id="filePill">
          <label>Agregar</label>
          <input id="fileInput" type="file" accept=".xlsx,.xls" multiple />
        </div>

        <div class="pill">
          <label>Item</label>
          <select id="itemSelect">
            <option value="__ALL__">Todos</option>
          </select>
        </div>

        <div class="pill">
          <label>Métrica</label>
          <select id="metricSelect">
            <option value="usd">USD (Total)</option>
            <option value="qty">Cantidad</option>
            <option value="unit">Precio Unitario</option>
          </select>
        </div>

        <div class="pill" style="min-width: 260px;">
          <label>Nube</label>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span class="badge mint" id="cloudStatus">Config pendiente</span>
            <button class="btn secondary" id="btnLogin" type="button" style="padding:10px 12px;">Ingresar</button>
            <button class="btn secondary" id="btnLogout" type="button" style="padding:10px 12px; display:none;">Salir</button>
            <button class="btn danger" id="btnCloudPurge" type="button" style="padding:10px 12px; display:none;">Limpiar nube</button>
          </div>
        </div>

        <button class="btn secondary" id="btnReset" type="button">Reset</button>
        <button class="btn" id="btnExport" type="button">Exportar (Excel)</button>
      </div>
    </div>
  </div>

  <div class="catbar-wrap">
    <div class="catbar">
      <div class="catbar-topline"></div>
      <div class="year-tabs" id="yearTabs"></div>
      <div class="cat-tabs" id="catTabs"></div>
    </div>
  </div>

  <div class="container">
    <div id="emptyState" class="empty">Carga tu primer archivo para ver el dashboard.</div>

    <div class="progress-pill" id="progressPill">
      <span id="progressText">Procesando…</span>
      <div class="progress-bar"><div id="progressFill"></div></div>
      <span class="badge gold" id="progressCount">0/0</span>
    </div>

    <div id="uploadsPanel" style="display:none; margin-top:14px;">
      <details class="uploads" id="uploadsDetails" open>
        <summary>
          <div class="uploads-title">
            Archivos cargados
            <span class="badge gold" id="badgeFilesLoaded">0</span>
            <span class="badge" id="badgeMonthsLoaded">0 meses</span>
            <span class="badge red" id="badgeFailed">0 fallidos</span>
          </div>
          <div style="display:flex; align-items:center; gap:10px;">
            <span class="badge" id="badgeLastUpload">—</span>
            <span class="chev" aria-hidden="true"></span>
          </div>
        </summary>
        <div class="uploads-body">
          <table class="uploads-table" id="uploadsTable">
            <thead>
              <tr>
                <th>Estado</th>
                <th>Mes</th>
                <th>Quincena</th>
                <th>Archivo</th>
                <th class="num">Filas items</th>
                <th class="num">Total USD</th>
                <th class="num">Saldo adeudado</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </details>
    </div>

    <div class="grid" id="dashboard" style="display:none;">
      <div class="card span-3">
        <div class="card-header">
          <div>
            <div class="card-title">Saldo adeudado</div>
            <div class="card-sub">Acumulado (por archivo)</div>
          </div>
          <span class="badge gold" id="badgeSaldoScope">Global</span>
        </div>
        <div class="card-body">
          <div class="kpi">
            <div>
              <div class="value" id="kpiSaldo">$0</div>
              <div class="hint" id="kpiSaldoHint">—</div>
            </div>
            <span class="badge" id="badgeSaldoPeriod">—</span>
          </div>
        </div>
      </div>

      <div class="card span-3">
        <div class="card-header">
          <div>
            <div class="card-title">Cantidad</div>
            <div class="card-sub">Acumulado</div>
          </div>
          <span class="badge" id="badgeItems">0 items</span>
        </div>
        <div class="card-body">
          <div class="kpi">
            <div>
              <div class="value" id="kpiQty">0</div>
              <div class="hint" id="kpiQtyHint">—</div>
            </div>
            <span class="badge" id="badgeMetric">USD</span>
          </div>
        </div>
      </div>

      <div class="card span-3">
        <div class="card-header">
          <div>
            <div class="card-title">Precio Unitario</div>
            <div class="card-sub">Promedio ponderado</div>
          </div>
          <span class="badge" id="badgeFilter">Todos</span>
        </div>
        <div class="card-body">
          <div class="kpi">
            <div>
              <div class="value" id="kpiUnit">$0</div>
              <div class="hint" id="kpiUnitHint">—</div>
            </div>
            <span class="badge" id="badgeCat">Todos</span>
          </div>
        </div>
      </div>

      <div class="card span-3">
        <div class="card-header">
          <div>
            <div class="card-title">Total USD</div>
            <div class="card-sub">Acumulado</div>
          </div>
          <span class="badge gold" id="badgeMonthsChip">0 meses</span>
        </div>
        <div class="card-body">
          <div class="kpi">
            <div>
              <div class="value" id="kpiUSD">$0</div>
              <div class="hint" id="kpiUSDHint">—</div>
            </div>
            <span class="badge" id="badgePeriod">—</span>
          </div>
        </div>
      </div>

      <div class="card span-12">
        <div class="card-header">
          <div>
            <div class="card-title">Tendencia mensual</div>
            <div class="card-sub">Suma por mes (1ra + 2da quincena)</div>
          </div>
          <span class="badge" id="badgeSeries">—</span>
        </div>
        <div class="card-body">
          <canvas id="lineChart" height="120"></canvas>
        </div>
      </div>

      <div class="card span-12">
        <div class="card-header">
          <div>
            <div class="card-title">Comparativo quincenas</div>
            <div class="card-sub">1ra vs 2da quincena (por mes)</div>
          </div>
          <span class="badge" id="badgeQCompare">—</span>
        </div>
        <div class="card-body">
          <canvas id="qChart" height="120"></canvas>
        </div>
      </div>

      <div class="card span-6">
        <div class="card-header">
          <div>
            <div class="card-title">Distribución por categoría</div>
            <div class="card-sub">Mix del acumulado</div>
          </div>
          <span class="badge" id="badgeMix">—</span>
        </div>
        <div class="card-body">
          <canvas id="donutChart" height="160"></canvas>
        </div>
      </div>

      <div class="card span-6">
        <div class="card-header">
          <div>
            <div class="card-title">Top items</div>
            <div class="card-sub">Último mes</div>
          </div>
          <span class="badge" id="badgeTopN">Top 10</span>
        </div>
        <div class="card-body">
          <canvas id="barChart" height="160"></canvas>
        </div>
      </div>

      <div class="card span-12">
        <div class="card-header">
          <div>
            <div class="card-title">Detalle</div>
            <div class="card-sub">Por archivo</div>
          </div>
          <span class="badge" id="badgeRows">0 filas</span>
        </div>
        <div class="card-body">
          <div class="table-wrap">
            <table id="dataTable">
              <thead>
                <tr>
                  <th>Mes</th>
                  <th>Quincena</th>
                  <th>Archivo</th>
                  <th>Categoría</th>
                  <th>Descripción</th>
                  <th>UND Tarifaria</th>
                  <th class="num">Cantidad</th>
                  <th class="num">Precio Unit.</th>
                  <th class="num">Total USD</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div>
      <strong id="toastTitle">Aviso</strong>
      <span id="toastMsg">—</span>
    </div>
    <button type="button" id="toastClose">OK</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
    function safeUpper(x){ return (x ?? "").toString().trim().toUpperCase(); }
    function normalizeText(x){
      return safeUpper(x)
        .replaceAll("Á","A").replaceAll("É","E").replaceAll("Í","I").replaceAll("Ó","O").replaceAll("Ú","U")
        .replaceAll("Ä","A").replaceAll("Ë","E").replaceAll("Ï","I").replaceAll("Ö","O").replaceAll("Ü","U");
    }
    function fmtUSD(n){
      if(!isFinite(n)) return "—";
      return n.toLocaleString("en-US",{style:"currency",currency:"USD"});
    }
    function fmtNum(n){
      if(!isFinite(n)) return "—";
      return n.toLocaleString("en-US",{maximumFractionDigits:2});
    }
    function fmtUnit(n){
      if(!isFinite(n)) return "—";
      return n.toLocaleString("en-US",{minimumFractionDigits:3, maximumFractionDigits:3});
    }
    function fmtCompactUSD(n){
      if(!isFinite(n)) return "—";
      const abs = Math.abs(n);
      if(abs >= 1_000_000) return "$" + (n/1_000_000).toFixed(2) + "M";
      if(abs >= 1_000) return "$" + (n/1_000).toFixed(1) + "k";
      return fmtUSD(n);
    }
    function fmtCompactNum(n){
      if(!isFinite(n)) return "—";
      const abs = Math.abs(n);
      if(abs >= 1_000_000) return (n/1_000_000).toFixed(2) + "M";
      if(abs >= 1_000) return (n/1_000).toFixed(1) + "k";
      return fmtNum(n);
    }
    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function toNumber(v){
      if(v === null || v === undefined || v === "") return NaN;
      if(typeof v === "number") return v;
      let s = (""+v).trim();
      s = s.replace(/[^\d\-,.]/g, "");
      if(!s) return NaN;
      if(s.includes(",") && s.includes(".")){
        s = s.replaceAll(",", "");
      }else if(s.includes(",") && !s.includes(".")){
        s = s.replaceAll(",", ".");
      }
      return Number(s);
    }
    function yyyymmLabel(year, month){
      const mm = String(month).padStart(2,"0");
      return `${year}-${mm}`;
    }
    function quincenaLabel(q){
      if(q === "Q1") return "1ra";
      if(q === "Q2") return "2da";
      return "—";
    }

    function detectQuincena(lower){
      const s = (lower || "").toString().toLowerCase();

      // Normaliza separadores para capturar cosas tipo "1erQ", "1er-Q", "1era15na", etc.
      const norm = s
        .replace(/[\u00B0º]/g, " ")     // símbolos de grado: 1º
        .replace(/[_\-\/]+/g, " ")
        .replace(/\s+/g, " ")
        .trim();

      // Q1 / Primera quincena
      const q1 =
        /\b(q1|1q)\b/.test(norm) ||
        /\b(primera|primer)\s+(quincena|15na|15ena|quince)\b/.test(norm) ||
        /\bquincena\s*1\b/.test(norm) ||
        /\b15na\s*1\b/.test(norm) ||
        /\b1\s*(er|ero|ra|era)?\s*(q|quin|quincena|15na|15ena|quince)\b/.test(norm);

      // Q2 / Segunda quincena
      const q2 =
        /\b(q2|2q)\b/.test(norm) ||
        /\b(segunda|segundo)\s+(quincena|15na|15ena|quince)\b/.test(norm) ||
        /\bquincena\s*2\b/.test(norm) ||
        /\b15na\s*2\b/.test(norm) ||
        /\b2\s*(do|da)?\s*(q|quin|quincena|15na|15ena|quince)\b/.test(norm);

      if(q1 && !q2) return "Q1";
      if(q2 && !q1) return "Q2";

      // Si por alguna razón aparecen ambos patrones, preferimos el que venga explícito (Q1/Q2).
      if(/\bq1\b/.test(norm) || /\b1q\b/.test(norm)) return "Q1";
      if(/\bq2\b/.test(norm) || /\b2q\b/.test(norm)) return "Q2";

      return null;
    }

    function parseMonthFromFilename(name){
      const lower = (name || "").toString().toLowerCase();
      const re = /(20\d{2})[-_ ]?(0[1-9]|1[0-2])/g;
      let m, last = null;
      while((m = re.exec(lower)) !== null){
        last = { y: Number(m[1]), mo: Number(m[2]) };
      }
      if(last) return yyyymmLabel(last.y, last.mo);

      const years = [...lower.matchAll(/(20\d{2})/g)].map(x=>Number(x[1]));
      const y = years.length ? years[years.length-1] : null;

      const months = {
        "enero":1,"febrero":2,"marzo":3,"abril":4,"mayo":5,"junio":6,"julio":7,"agosto":8,
        "septiembre":9,"setiembre":9,"octubre":10,"noviembre":11,"diciembre":12
      };
      let mo = null;
      for(const k of Object.keys(months)){
        if(lower.includes(k)){ mo = months[k]; break; }
      }
      if(y && mo) return yyyymmLabel(y, mo);

      return null;
    }

    function parsePeriodInfo(fileName, sheetName){
      const lowerFile = (fileName||"").toString().toLowerCase();
      const lowerSheet = (sheetName||"").toString().toLowerCase();
      const month = parseMonthFromFilename(fileName) || parseMonthFromFilename(sheetName);
      const q = detectQuincena(lowerFile) || detectQuincena(lowerSheet);
      return { month, q };
    }

    function categoryFromItemStrict(desc){
      const d = normalizeText(desc);
      if(d.startsWith("ALMACENAMIENTO SECO")) return "Almacenaje";
      if(d.startsWith("ALMACENAMIENTO Y PICKING FIJO")) return "Almacenaje";
      if(d.startsWith("BULK")) return "Almacenaje";
      if(d.includes("SILLA STUDIO")) return "Almacenaje";
      if(d.includes("RECEPCION IMPORTACION")) return "Recepcion";
      if(d === "DESPACHO" || d.includes("DESPACHO")) return "Despacho";
      if(d.includes("HORA EXTRA") || d.includes("HORAS EXTRA")) return "Horas extras";
      if(d.includes("ETIQUETADO DE UNIDADES")) return "Maquilas";
      if(d.includes("ALIMENTACION")) return "Otros servicio";
      if(d.includes("ESPACIO DE TRABAJO IN HOUSE")) return "Otros servicio";
      return "Otros servicio";
    }

    function scoreHeaderRow(row){
      const s = (row || []).map(v => normalizeText(v)).join(" | ");
      let score = 0;
      if(s.includes("DESCRIP")) score += 3;
      if(s.includes("UND TARIF")) score += 2;
      if(s.includes("CANT")) score += 2;
      if(s.includes("PRECIO")) score += 2;
      if(s.includes("TOTAL")) score += 2;
      return score;
    }
    function findHeaderRowSmart(rows){
      let bestIdx = -1, bestScore = 0;
      for(let i=0;i<Math.min(rows.length, 140);i++){
        const sc = scoreHeaderRow(rows[i] || []);
        if(sc > bestScore){
          bestScore = sc;
          bestIdx = i;
        }
      }
      return (bestScore >= 7) ? bestIdx : -1;
    }
    function colIndex(headerRow, candidates){
      const header = (headerRow || []).map(v => normalizeText(v));
      for(const cand of candidates){
        const target = normalizeText(cand);
        for(let i=0;i<header.length;i++){
          if(header[i] === target) return i;
        }
      }
      for(const cand of candidates){
        const target = normalizeText(cand);
        for(let i=0;i<header.length;i++){
          if(header[i] && header[i].includes(target)) return i;
        }
      }
      return -1;
    }

    function findSaldoAdeudado(workbook){
      const sheetNames = workbook.SheetNames || [];
      for(const sheetName of sheetNames){
        const ws = workbook.Sheets[sheetName];
        if(!ws) continue;
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: null });
        if(!rows || !rows.length) continue;

        for(let r=0; r<Math.min(rows.length, 300); r++){
          const row = rows[r] || [];
          for(let c=0; c<row.length; c++){
            const cell = row[c];
            if(!cell) continue;
            const t = normalizeText(cell);
            if(t.includes("SALDO ADEUDADO")){
              for(let k=1; k<=8; k++){
                const val = row[c+k];
                const num = toNumber(val);
                if(isFinite(num)) return num;
              }
              const next = rows[r+1] || [];
              for(let k=0; k<=8; k++){
                const num = toNumber(next[c+k]);
                if(isFinite(num)) return num;
              }
            }
          }
        }
      }
      return NaN;
    }

    function parseRecuadroFromWorkbook(workbook, fileName){
      const sheetNames = workbook.SheetNames || [];
      const preferred = sheetNames
        .filter(n => /resumen|cuadro/i.test(n))
        .concat(sheetNames.filter(n => !/resumen|cuadro/i.test(n)));

      const saldo = findSaldoAdeudado(workbook);

      for(const sheetName of preferred){
        const ws = workbook.Sheets[sheetName];
        if(!ws) continue;

        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: null });
        if(!rows || !rows.length) continue;

        const headerIdx = findHeaderRowSmart(rows);
        if(headerIdx < 0) continue;

        const header = rows[headerIdx];

        const idxDesc = colIndex(header, ["DESCRIPCIÓN","DESCRIPCION","DESCRIP"]);
        const idxUnd  = colIndex(header, ["UND TARIFARIA","UND TARIF","UND"]);
        const idxQty  = colIndex(header, ["CANTIDAD","CANT"]);
        const idxUnit = colIndex(header, ["PRECIO UNITARIO","PRECIO"]);
        const idxTot  = colIndex(header, ["TOTAL","TOTAL USD","USD"]);

        if(idxDesc < 0 || idxUnd < 0 || idxQty < 0 || idxUnit < 0 || idxTot < 0) continue;

        const periodInfo = parsePeriodInfo(fileName, sheetName);
        let month = periodInfo.month;
        let q = periodInfo.q;

        if(!month){
          const now = new Date();
          month = yyyymmLabel(now.getFullYear(), now.getMonth()+1);
        }

        let records = [];
        let blankDescStreak = 0;

        for(let r=headerIdx+1; r<rows.length; r++){
          const row = rows[r] ?? [];
          const desc = (row[idxDesc] ?? "").toString().trim();

          if(!desc){
            blankDescStreak++;
            if(blankDescStreak >= 2) break;
            continue;
          }
          blankDescStreak = 0;

          const descUp = normalizeText(desc);
          if(descUp === "TOTAL" || descUp.startsWith("TOTAL ") || descUp.startsWith("SUBTOTAL") || descUp.includes("DESCUENTO") || descUp.includes("TASA") || descUp.includes("IMPUEST")) continue;

          const qty = toNumber(row[idxQty]);
          const unit = toNumber(row[idxUnit]);
          const tot = toNumber(row[idxTot]);
          if(!isFinite(tot)) continue;

          const und = (row[idxUnd] ?? "").toString().trim() || "—";
          const cat = categoryFromItemStrict(desc);

          records.push({
            month,
            quincena: q,
            file: fileName,
            sheet: sheetName,
            category: cat,
            item: desc,
            undTarifaria: und,
            qty: isFinite(qty) ? qty : 0,
            unit: isFinite(unit) ? unit : 0,
            usd: tot
          });
        }

        const key = (r)=>`${r.file}||${r.month}||${r.quincena||""}||${normalizeText(r.category)}||${normalizeText(r.item)}||${normalizeText(r.undTarifaria)}`;
        const map = new Map();
        for(const r of records){
          const k = key(r);
          const cur = map.get(k) || { ...r, usd:0, qty:0, unitWeighted:0, unitWeight:0 };
          cur.usd += r.usd || 0;
          cur.qty += r.qty || 0;
          if(r.unit && r.unit>0 && r.qty && r.qty>0){
            cur.unitWeighted += r.unit * r.qty;
            cur.unitWeight += r.qty;
          }
          map.set(k, cur);
        }
        records = [...map.values()].map(x=>{
          const unitCalc = x.unitWeight>0 ? (x.unitWeighted/x.unitWeight) : (x.unit||0);
          const { unitWeighted, unitWeight, ...rest } = x;
          return { ...rest, unit: unitCalc };
        });

        if(records.length){
          return { records, fileSummary: { file:fileName, month, quincena:q, saldo: saldo, rows: records.length, usd: records.reduce((s,r)=>s+(r.usd||0),0) } };
        }
      }

      return { records: [], fileSummary: { file:fileName, month: parseMonthFromFilename(fileName), quincena: detectQuincena((fileName||"").toLowerCase()), saldo: saldo, rows:0, usd:0 }, error: "No encontré el recuadro (DESCRIPCIÓN / UND TARIFARIA / CANTIDAD / PRECIO UNITARIO / TOTAL) en ninguna hoja." };
    }

    let allRecords = [];
    let fileSummaries = new Map();

    let lineChart = null;
    let barChart = null;
    let donutChart = null;
    let qChart = null;

    Chart.register(ChartDataLabels);


    // =========================
    // Firebase (online) - pega tu config aquí
    // =========================
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyCZcGQy9ualGQ37SSWiUwa65AujPdJw3dY",
      authDomain: "dashboard-facturaciones.firebaseapp.com",
      projectId: "dashboard-facturaciones",
      storageBucket: "dashboard-facturaciones.firebasestorage.app",
      messagingSenderId: "310892155298",
      appId: "1:310892155298:web:045f46a16bf11477c122fb"
    };

    // Colección donde se guardan las cargas (1 doc por archivo)
    const CLOUD_COLLECTION = "dashboard_servicios_uploads";

    // Admins autorizados a subir/eliminar (opcional). Si dejas vacío, cualquier usuario logueado será admin.
    const ADMIN_EMAILS = [
      // "tu_correo@empresa.com"
    ].map(x => (x||"").toLowerCase());

    const cloud = {
      enabled: false,
      db: null,
      auth: null,
      user: null,
      isAdmin: false,
      initialized: false
    };

    // Para mantener fallas locales visibles aunque haya sync online
    const localFailures = new Map(); // fileName -> error

    function isConfigPasted(cfg){
      const v = (cfg && cfg.apiKey) ? String(cfg.apiKey) : "";
      return v && !v.includes("PEGAR_AQUI");
    }
    function setCloudStatus(text, kind="mint"){
      if(!el.cloudStatus) return;
      el.cloudStatus.textContent = text;
      el.cloudStatus.className = "badge " + kind;
    }
    function setAdminUI(){
      const showUpload = cloud.enabled ? cloud.isAdmin : true; // en local siempre
      if(el.filePill) el.filePill.style.display = showUpload ? "" : "none";
      el.btnLogin.style.display = (cloud.enabled && !cloud.user) ? "" : "none";
      el.btnLogout.style.display = (cloud.enabled && !!cloud.user) ? "" : "none";
      if(el.btnCloudPurge) el.btnCloudPurge.style.display = (cloud.enabled && cloud.isAdmin && !!cloud.user) ? "" : "none";
    }

    
    function canUseWebStorage(){
      try{
        const k="__of_test__"+String(Date.now());
        localStorage.setItem(k,"1");
        localStorage.removeItem(k);
        return true;
      }catch(e){
        return false;
      }
    }
    function isHttpProtocol(){
      return location.protocol === "https:" || location.protocol === "http:";
    }
function decodeURIComponentSafe(x){
      try{ return decodeURIComponent(x); }catch(e){ return null; }
    }

    function rebuildFromCloudDocs(docs){
      // Reconstruye dataset desde Firestore
      const nextSummaries = new Map();
      const nextRecords = [];

      for(const u of docs){
        const file = u.fileName || decodeURIComponentSafe(u.id) || u.id;
        const month = u.month || parseMonthFromFilename(file);
        const quincena = u.quincena || detectQuincena(String(file).toLowerCase());
        const saldo = (u.saldo === null || u.saldo === undefined) ? NaN : Number(u.saldo);
        const rows = Number(u.rows || 0);
        const usd = Number(u.usd || 0);

        nextSummaries.set(file, { file, month, quincena, saldo, rows, usd, status:"ok" });

        const recs = Array.isArray(u.records) ? u.records : [];
        for(const r of recs){
          nextRecords.push({
            file,
            month,
            quincena,
            category: (r.category ?? "").toString(),
            item: (r.item ?? "").toString(),
            undTarifaria: (r.undTarifaria ?? "").toString(),
            qty: Number(r.qty || 0),
            unit: Number(r.unit || 0),
            usd: Number(r.usd || 0)
          });
        }
      }

      // Mezcla fallas locales recientes
      for(const [file, err] of localFailures.entries()){
        if(!nextSummaries.has(file)){
          nextSummaries.set(file, { file, month: parseMonthFromFilename(file), quincena: detectQuincena(String(file).toLowerCase()), saldo: NaN, rows:0, usd:0, status:"fail", error: err });
        }
      }

      allRecords = nextRecords;
      fileSummaries = nextSummaries;
      refreshAll();
    }

    async function upsertCloudUpload(fileObj, parsed){
      const docId = encodeURIComponent(fileObj.name);
      const recs = parsed.records.map(r=>({
        category: r.category,
        item: r.item,
        undTarifaria: r.undTarifaria,
        qty: Number(r.qty || 0),
        unit: Number(r.unit || 0),
        usd: Number(r.usd || 0)
      }));
      const usd = recs.reduce((s,a)=> s + (Number(a.usd)||0), 0);

      const payload = {
        fileName: fileObj.name,
        month: parsed.fileSummary?.month || parseMonthFromFilename(fileObj.name),
        quincena: parsed.fileSummary?.quincena || detectQuincena(String(fileObj.name).toLowerCase()),
        saldo: isFinite(parsed.fileSummary?.saldo) ? Number(parsed.fileSummary.saldo) : null,
        rows: recs.length,
        usd,
        records: recs,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      await cloud.db.collection(CLOUD_COLLECTION).doc(docId).set(payload, { merge:true });
    }

    async function deleteCloudUpload(fileName){
      const docId = encodeURIComponent(fileName);
      await cloud.db.collection(CLOUD_COLLECTION).doc(docId).delete();
    }

    async function purgeCloudUploads(){
      if(!cloud.enabled) return;
      if(!cloud.user || !cloud.isAdmin){
        toast("Acceso", "Solo admin puede limpiar la nube.");
        return;
      }
      const ok = confirm("Esto borrará TODAS las cargas guardadas en la nube (Firestore). ¿Seguro?");
      if(!ok) return;

      setCloudStatus("Limpiando…", "gold");

      try{
        // Borrado por lotes (máx 500 por batch)
        const col = cloud.db.collection(CLOUD_COLLECTION);
        let totalDeleted = 0;

        while(true){
          const snap = await col.limit(500).get();
          if(snap.empty) break;

          const batch = cloud.db.batch();
          snap.docs.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
          totalDeleted += snap.size;
        }

        toast("Nube", "Listo. Se eliminaron " + totalDeleted + " cargas.");
        setCloudStatus("Online", "mint");
      }catch(e){
        setCloudStatus("Offline", "gold");
        toast("Firebase", "No se pudo limpiar la nube: " + (e?.message || e));
      }
    }


    function initCloud(){
      if(cloud.initialized) return;
      cloud.initialized = true;

      if(!window.firebase){
        setCloudStatus("Sin Firebase", "gold");
        setAdminUI();
        return;
      }
      if(!isConfigPasted(FIREBASE_CONFIG)){
        setCloudStatus("Config pendiente", "gold");
        setAdminUI();
        return;
      }

      try{
        firebase.initializeApp(FIREBASE_CONFIG);
        cloud.db = firebase.firestore();
        cloud.auth = firebase.auth();
        cloud.enabled = true;
        setCloudStatus("Conectando…", "mint");
      }catch(e){
        setCloudStatus("Error", "red");
        toast("Firebase", "No se pudo inicializar: " + (e?.message || e));
        setAdminUI();
        return;
      }

      cloud.auth.onAuthStateChanged((user)=>{
        cloud.user = user || null;
        const email = (user?.email || "").toLowerCase();
        cloud.isAdmin = !!user && (ADMIN_EMAILS.length === 0 || ADMIN_EMAILS.includes(email));
        if(user && !cloud.isAdmin){
          toast("Modo visor", "Tu cuenta tiene acceso de lectura. Para subir/eliminar, registra tu correo en ADMIN_EMAILS y en reglas de Firestore.");
        }
        setAdminUI();
      });

      // Si se usó redirect, captura resultado/errores
      try{
        cloud.auth.getRedirectResult().catch((e)=>{
          if(e) toast("Login", e?.message || e);
        });
      }catch(e){ /* noop */ }

      // Realtime sync (lectura pública)
      cloud.db.collection(CLOUD_COLLECTION).onSnapshot((snap)=>{
        const docs = [];
        snap.forEach(d=> docs.push({ id:d.id, ...d.data() }));
        setCloudStatus("Online", "mint");
        rebuildFromCloudDocs(docs);
      }, (err)=>{
        setCloudStatus("Offline", "gold");
        toast("Firebase", "No se pudo sincronizar: " + (err?.message || err));
      });

      setAdminUI();
    }

    const CAT_ORDER = [
      { key: "__ALL__", label: "Todos", css: "all" },
      { key: "ALMACENAJE", label: "Almacenaje" },
      { key: "RECEPCION", label: "Recepcion" },
      { key: "DESPACHO", label: "Despacho" },
      { key: "HORAS EXTRAS", label: "Horas extras" },
      { key: "OTROS SERVICIO", label: "Otros servicio" },
      { key: "MAQUILAS", label: "Maquilas" },
      { key: "ESTIBAS", label: "Estibas" }
    ];

    const el = {
      filePill: document.getElementById("filePill"),
      fileInput: document.getElementById("fileInput"),
      cloudStatus: document.getElementById("cloudStatus"),
      btnLogin: document.getElementById("btnLogin"),
      btnLogout: document.getElementById("btnLogout"),
      itemSelect: document.getElementById("itemSelect"),
      metricSelect: document.getElementById("metricSelect"),
      btnReset: document.getElementById("btnReset"),
      btnExport: document.getElementById("btnExport"),
      emptyState: document.getElementById("emptyState"),
      dashboard: document.getElementById("dashboard"),
      uploadsPanel: document.getElementById("uploadsPanel"),
      uploadsTBody: document.querySelector("#uploadsTable tbody"),
      badgeFilesLoaded: document.getElementById("badgeFilesLoaded"),
      badgeMonthsLoaded: document.getElementById("badgeMonthsLoaded"),
      badgeFailed: document.getElementById("badgeFailed"),
      badgeLastUpload: document.getElementById("badgeLastUpload"),
      progressPill: document.getElementById("progressPill"),
      progressText: document.getElementById("progressText"),
      progressFill: document.getElementById("progressFill"),
      progressCount: document.getElementById("progressCount"),
      kpiSaldo: document.getElementById("kpiSaldo"),
      kpiSaldoHint: document.getElementById("kpiSaldoHint"),
      badgeSaldoPeriod: document.getElementById("badgeSaldoPeriod"),
      kpiUSD: document.getElementById("kpiUSD"),
      kpiQty: document.getElementById("kpiQty"),
      kpiUnit: document.getElementById("kpiUnit"),
      kpiUSDHint: document.getElementById("kpiUSDHint"),
      kpiQtyHint: document.getElementById("kpiQtyHint"),
      kpiUnitHint: document.getElementById("kpiUnitHint"),
      badgeItems: document.getElementById("badgeItems"),
      badgeFilter: document.getElementById("badgeFilter"),
      badgeMetric: document.getElementById("badgeMetric"),
      badgePeriod: document.getElementById("badgePeriod"),
      badgeSeries: document.getElementById("badgeSeries"),
      badgeRows: document.getElementById("badgeRows"),
      badgeCat: document.getElementById("badgeCat"),
      badgeMix: document.getElementById("badgeMix"),
      badgeMonthsChip: document.getElementById("badgeMonthsChip"),
      badgeQCompare: document.getElementById("badgeQCompare"),
      tableBody: document.querySelector("#dataTable tbody"),
      yearTabs: document.getElementById("yearTabs"),
      catTabs: document.getElementById("catTabs"),
      toast: document.getElementById("toast"),
      toastTitle: document.getElementById("toastTitle"),
      toastMsg: document.getElementById("toastMsg"),
      toastClose: document.getElementById("toastClose")
    };

    let activeCategory = "__ALL__";
    let activeYear = "__ALL__";

    function syncStickyOffsets(){
      const tb = document.querySelector(".topbar");
      if(!tb) return;
      const h = tb.getBoundingClientRect().height;
      document.documentElement.style.setProperty("--topbar-h", `${Math.ceil(h)}px`);
    }
    window.addEventListener("resize", ()=>{ syncStickyOffsets(); });

    function toast(title, msg){
      el.toastTitle.textContent = title || "Aviso";
      el.toastMsg.textContent = msg || "";
      el.toast.style.display = "flex";
    }
    el.toastClose.addEventListener("click", ()=> el.toast.style.display = "none");

    function showDashboard(){
      el.emptyState.style.display = "none";
      el.dashboard.style.display = "grid";
      el.uploadsPanel.style.display = "block";
    }
    function showEmpty(){
      el.emptyState.style.display = "block";
      el.dashboard.style.display = "none";
      el.uploadsPanel.style.display = "none";
    }

    function yearsAvailable(){
      const years = new Set();
      for(const r of allRecords){
        const m = (r.month || "").toString().trim();
        const y = m.slice(0,4);
        if(/^\d{4}$/.test(y)) years.add(y);
      }
      return [...years].sort((a,b)=>a.localeCompare(b));
    }

    function recordsForYear(){
      if(activeYear === "__ALL__") return allRecords;
      return allRecords.filter(r=>{
        const m = (r.month || "").toString();
        return m.startsWith(activeYear + "-") || m === activeYear;
      });
    }

    function renderYearTabs(){
      if(!el.yearTabs) return;
      if(allRecords.length === 0){
        el.yearTabs.innerHTML = "";
        return;
      }

      const years = yearsAvailable();
      const valid = new Set(["__ALL__", ...years]);
      if(!valid.has(activeYear)) activeYear = "__ALL__";

      const btns = [{ key:"__ALL__", label:"General" }, ...years.map(y=>({ key:y, label:y }))];

      el.yearTabs.innerHTML = btns.map(b=>{
        const classes = ["year-btn"];
        if(activeYear === b.key) classes.push("active");
        return `<button class="${classes.join(" ")}" data-year="${b.key}" type="button">${b.label}</button>`;
      }).join("");

      el.yearTabs.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          activeYear = btn.dataset.year;
          el.itemSelect.value = "__ALL__";
          refreshAll();
        });
      });
    }

    function renderCatTabs(){
      const base = recordsForYear();

      const counts = new Map();
      for(const r of base){
        const k = normalizeText(r.category);
        counts.set(k, (counts.get(k) || 0) + 1);
      }

      el.catTabs.innerHTML = CAT_ORDER.map(c=>{
        const classes = ["cat-btn"];
        if(c.css) classes.push(c.css);
        if(activeCategory === c.key) classes.push("active");
        const cnt = (c.key === "__ALL__") ? base.length : (counts.get(c.key) || 0);
        return `<button class="${classes.join(" ")}" data-cat="${c.key}" type="button">
          ${c.label}<span class="cat-count">${cnt}</span>
        </button>`;
      }).join("");

      el.catTabs.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          activeCategory = btn.dataset.cat;
          el.itemSelect.value = "__ALL__";
          refreshAll();
        });
      });
    }

    function filteredRecords(){
      const base = recordsForYear();
      const item = el.itemSelect.value;
      const cat = activeCategory;
      return base.filter(r => {
        const okCat = (cat === "__ALL__") ? true : normalizeText(r.category) === cat;
        const okItem = (item === "__ALL__") ? true : r.item === item;
        return okCat && okItem;
      });
    }

    function monthsSorted(records){
      return [...new Set(records.map(r=>r.month))].filter(Boolean).sort();
    }

    function aggregateByMonth(records){
      const map = new Map();
      for(const r of records){
        const key = r.month;
        const cur = map.get(key) || { month:key, usd:0, qty:0, unitWeighted:0, unitWeight:0 };
        cur.usd += (isFinite(r.usd) ? r.usd : 0);
        cur.qty += (isFinite(r.qty) ? r.qty : 0);
        if(isFinite(r.unit) && r.unit > 0 && isFinite(r.qty) && r.qty > 0){
          cur.unitWeighted += r.unit * r.qty;
          cur.unitWeight += r.qty;
        }
        map.set(key, cur);
      }
      const arr = [...map.values()].sort((a,b)=>a.month.localeCompare(b.month));
      for(const a of arr){
        a.unit = a.unitWeight > 0 ? (a.unitWeighted / a.unitWeight) : 0;
      }
      return arr;
    }

    function aggregateByCategory(records){
      const map = new Map();
      for(const r of records){
        const key = r.category;
        const cur = map.get(key) || { category:key, usd:0, qty:0, unitWeighted:0, unitWeight:0 };
        cur.usd += r.usd || 0;
        cur.qty += r.qty || 0;
        if(r.unit && r.unit>0 && r.qty && r.qty>0){
          cur.unitWeighted += r.unit * r.qty;
          cur.unitWeight += r.qty;
        }
        map.set(key, cur);
      }
      const arr = [...map.values()];
      for(const a of arr){
        a.unit = a.unitWeight > 0 ? (a.unitWeighted / a.unitWeight) : 0;
      }
      return arr.sort((a,b)=>b.usd-a.usd);
    }

    function aggregateByItemLatestMonth(records){
      const months = monthsSorted(records);
      const latest = months[months.length-1];
      const latestRecords = records.filter(r=>r.month === latest);

      const map = new Map();
      for(const r of latestRecords){
        const cur = map.get(r.item) || { item:r.item, usd:0, qty:0, unitWeighted:0, unitWeight:0 };
        cur.usd += r.usd || 0;
        cur.qty += r.qty || 0;
        if(r.unit && r.unit>0 && r.qty && r.qty>0){
          cur.unitWeighted += r.unit * r.qty;
          cur.unitWeight += r.qty;
        }
        map.set(r.item, cur);
      }
      const arr = [...map.values()];
      for(const a of arr){
        a.unit = a.unitWeight > 0 ? (a.unitWeighted / a.unitWeight) : 0;
      }
      return { latest, items: arr.sort((a,b)=>b.usd-a.usd) };
    }

    function aggregateQuincenasByMonth(records){
      const metric = el.metricSelect.value;
      const base = (records && records.length) ? records : [];
      const months = monthsSorted(base);
      const out = { months, q1: [], q2: [] };
      for(const m of months){
        const rMonth = base.filter(r=>r.month===m);
        const calc = (q) => {
          const rs = rMonth.filter(r => (r.quincena || "") === q);
          if(metric === "usd") return rs.reduce((s,r)=>s+(r.usd||0),0);
          if(metric === "qty") return rs.reduce((s,r)=>s+(r.qty||0),0);
          let uw=0,w=0;
          for(const r of rs){
            if(r.unit && r.unit>0 && r.qty && r.qty>0){
              uw += r.unit * r.qty;
              w += r.qty;
            }
          }
          return w>0 ? (uw/w) : 0;
        };
        out.q1.push(calc("Q1"));
        out.q2.push(calc("Q2"));
      }
      return out;
    }

    function refreshItemSelect(){
      const rec = filteredRecords();
      const items = [...new Set(rec.map(r=>r.item))].sort((a,b)=>a.localeCompare(b));
      const current = el.itemSelect.value;
      el.itemSelect.innerHTML = `<option value="__ALL__">Todos</option>` + items.map(i=>`<option value="${escapeHtml(i)}">${escapeHtml(i)}</option>`).join("");
      if(items.includes(current)) el.itemSelect.value = current;
      else el.itemSelect.value = "__ALL__";
    }

    function renderUploadsPanel(){
      const summaries = [...fileSummaries.values()].sort((a,b)=> (a.month||"").localeCompare(b.month||"") || (a.file||"").localeCompare(b.file||""));
      const ok = summaries.filter(s=>s.status==="ok");
      const bad = summaries.filter(s=>s.status!=="ok");
      const canDelete = (!cloud.enabled) || cloud.isAdmin;

      const months = new Set(ok.map(s=>s.month).filter(Boolean));
      el.badgeFilesLoaded.textContent = String(ok.length);
      el.badgeMonthsLoaded.textContent = `${months.size} meses`;
      el.badgeFailed.textContent = `${bad.length} fallidos`;

      const last = summaries.length ? summaries[summaries.length-1] : null;
      el.badgeLastUpload.textContent = last ? `Último: ${last.file}` : "—";

      el.badgeMonthsChip.textContent = `${months.size} meses`;

      el.uploadsTBody.innerHTML = summaries.map(s=>{
        const statusBadge = s.status==="ok"
          ? `<span class="badge">OK</span>`
          : `<span class="badge red">ERROR</span>`;
        return `
          <tr>
            <td>${statusBadge}</td>
            <td>${escapeHtml(s.month || "—")}</td>
            <td>${escapeHtml(quincenaLabel(s.quincena))}</td>
            <td>${escapeHtml(s.file)}</td>
            <td class="num">${fmtNum(s.rows || 0)}</td>
            <td class="num">${fmtUSD(s.usd || 0)}</td>
            <td class="num">${isFinite(s.saldo) ? fmtUSD(s.saldo) : "—"}</td>
            <td>${canDelete ? ('<button class="mini-btn" data-remove="'+escapeHtml(s.file)+'">Eliminar</button>') : "—"}</td>
          </tr>
        `;
      }).join("");

      el.uploadsTBody.querySelectorAll("button[data-remove]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const f = btn.getAttribute("data-remove");
          if(!f) return;

          if(cloud.enabled){
            if(!cloud.isAdmin){
              toast("Acceso", "Solo admin puede eliminar cargas en la nube.");
              return;
            }
            try{
              await deleteCloudUpload(f);
              // La UI se refresca por onSnapshot automáticamente
            }catch(e){
              toast("Firebase", "No se pudo eliminar: " + (e?.message || e));
            }
            return;
          }

          // Local
          allRecords = allRecords.filter(r => r.file !== f);
          fileSummaries.delete(f);
          if(allRecords.length === 0){
            activeCategory = "__ALL__";
      activeYear = "__ALL__";
          }
          refreshAll();
        });
      });

      if(bad.length){
        const lines = bad.slice(0,6).map(s=>`- ${s.file}: ${s.error || "no se detectó el recuadro"}`).join("\n");
        const more = bad.length > 6 ? `\n… y ${bad.length-6} más.` : "";
        toast("Algunos archivos fallaron", `${lines}${more}`);
      }
    }

    function renderKPIs(filtered){
      const agg = aggregateByMonth(filtered);
      const totalUSD = agg.reduce((s,a)=>s+a.usd,0);
      const totalQty = agg.reduce((s,a)=>s+a.qty,0);
      let uw=0, w=0;
      for(const r of filtered){
        if(isFinite(r.unit) && r.unit>0 && isFinite(r.qty) && r.qty>0){
          uw += r.unit * r.qty;
          w += r.qty;
        }
      }
      const unit = w>0 ? (uw/w) : 0;

      el.kpiUSD.textContent = fmtUSD(totalUSD);
      el.kpiQty.textContent = fmtNum(totalQty);
      el.kpiUnit.textContent = fmtUSD(unit);

      const months = monthsSorted(allRecords);
      el.badgePeriod.textContent = months.length ? `${months[0]} → ${months[months.length-1]}` : "—";

      el.badgeItems.textContent = `${new Set(allRecords.map(r=>r.item)).size} items`;
      el.badgeMetric.textContent = el.metricSelect.value.toUpperCase();
      el.badgeFilter.textContent = (el.itemSelect.value === "__ALL__") ? "Todos" : el.itemSelect.value;

      const catLabel = activeCategory === "__ALL__"
        ? "Todos"
        : (CAT_ORDER.find(x=>x.key===activeCategory)?.label || activeCategory);
      el.badgeCat.textContent = catLabel;

      el.kpiUSDHint.textContent = `${agg.length} meses (según filtro)`;
      el.kpiQtyHint.textContent = `—`;
      el.kpiUnitHint.textContent = `Ponderado`;

      const ok = [...fileSummaries.values()].filter(s=>s.status==="ok");
      const saldoSum = ok.reduce((s,x)=> s + (isFinite(x.saldo) ? x.saldo : 0), 0);
      const monthsOk = [...new Set(ok.map(x=>x.month).filter(Boolean))].sort();
      el.kpiSaldo.textContent = fmtUSD(saldoSum);
      el.kpiSaldoHint.textContent = `${ok.length} archivos (global)`;
      el.badgeSaldoPeriod.textContent = monthsOk.length ? `${monthsOk[0]} → ${monthsOk[monthsOk.length-1]}` : "—";
    }

    function datalabelFormatter(metric, v){
      if(metric === "usd") return fmtCompactUSD(v);
      if(metric === "qty") return fmtCompactNum(v);
      return fmtUnit(v);
    }

    function renderLineChart(records){
      const metric = el.metricSelect.value;
      const agg = aggregateByMonth(records);
      const labels = agg.map(a=>a.month);
      const values = agg.map(a=>{
        if(metric==="usd") return a.usd;
        if(metric==="qty") return a.qty;
        if(metric==="unit") return a.unit;
        return a.usd;
      });

      el.badgeSeries.textContent = `${labels.length} puntos`;

      const ctx = document.getElementById("lineChart");
      if(lineChart) lineChart.destroy();
      lineChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: metric.toUpperCase(),
            data: values,
            tension: 0.25,
            fill: false,
            borderWidth: 3,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              align: "top",
              anchor: "end",
              offset: 6,
              clamp: true,
              color: "#0b3d2e",
              font: { weight: "800", size: 10 },
              formatter: (v)=> datalabelFormatter(metric, v)
            },
            tooltip: {
              callbacks: {
                label: (c) => {
                  const v = c.parsed.y;
                  if(metric==="usd" || metric==="unit") return ` ${fmtUSD(v)}`;
                  return ` ${fmtNum(v)}`;
                }
              }
            }
          },
          scales: {
            y: {
              ticks: { callback: (v) => (metric==="usd" || metric==="unit") ? fmtUSD(v) : fmtNum(v) },
              grid: { color: "rgba(2,6,23,.06)" }
            },
            x: { grid: { color: "rgba(2,6,23,.04)" } }
          }
        }
      });
    }

    function renderQuincenaChart(){
      const metric = el.metricSelect.value;
      const base = filteredRecords();
      const data = aggregateQuincenasByMonth(base);
      // Aviso: si no hay 1ra quincena detectada pero sí 2da, normalmente es por nombre de archivo
      const hasQ2 = data.q2.some(v => isFinite(v) && v !== 0);
      const hasQ1 = data.q1.some(v => isFinite(v) && v !== 0);
      if(hasQ2 && !hasQ1){
        toast("No aparece 1ra quincena", "Con el filtro actual, no se detecta data de 1ra quincena (Q1). Revisa en 'Archivos cargados' la columna Quincena (debe decir 1ra). Si sale '—', renombra el archivo (ej: 'Enero 1er Q 2025' o 'Enero Q1 2025' o 'Enero 1era 15na 2025').");
      }
      const labels = data.months;
      const ctx = document.getElementById("qChart");
      if(qChart) qChart.destroy();

      el.badgeQCompare.textContent = `1ra vs 2da (${metric.toUpperCase()})`;

      qChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "1ra quincena", data: data.q1, borderWidth: 1 },
            { label: "2da quincena", data: data.q2, borderWidth: 1 }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            datalabels: {
              anchor: "end",
              align: "end",
              offset: 2,
              color: "#0f172a",
              font: { weight: "800", size: 10 },
              formatter: (v)=> {
                if(!isFinite(v) || v===0) return "";
                return datalabelFormatter(metric, v);
              }
            },
            tooltip: {
              callbacks: {
                label: (c) => {
                  const v = c.parsed.y;
                  if(metric==="usd" || metric==="unit") return ` ${c.dataset.label}: ${fmtUSD(v)}`;
                  return ` ${c.dataset.label}: ${fmtNum(v)}`;
                }
              }
            }
          },
          scales: {
            y: {
              ticks: { callback: (v) => (metric==="usd" || metric==="unit") ? fmtUSD(v) : fmtNum(v) },
              grid: { color: "rgba(2,6,23,.06)" }
            },
            x: { grid: { display:false } }
          }
        }
      });
    }

    function renderDonut(records){
      const metric = el.metricSelect.value === "unit" ? "usd" : el.metricSelect.value;
      const cats = aggregateByCategory(records);
      const labels = cats.map(c=>c.category);
      const values = cats.map(c=>{
        if(metric==="usd") return c.usd;
        if(metric==="qty") return c.qty;
        return c.usd;
      });

      el.badgeMix.textContent = metric.toUpperCase();

      const ctx = document.getElementById("donutChart");
      if(donutChart) donutChart.destroy();
      donutChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data: values,
            borderWidth: 1,
            hoverOffset: 6
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            datalabels: {
              color: "#0f172a",
              font: { weight: "800", size: 10 },
              formatter: (v, ctx) => {
                const sum = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+(isFinite(b)?b:0),0);
                if(!sum || !isFinite(v)) return "";
                const pct = (v/sum)*100;
                if(pct < 6) return "";
                return pct.toFixed(0) + "%";
              }
            },
            tooltip: {
              callbacks: {
                label: (c) => {
                  const v = c.parsed;
                  if(metric==="usd") return ` ${c.label}: ${fmtUSD(v)}`;
                  return ` ${c.label}: ${fmtNum(v)}`;
                }
              }
            }
          }
        }
      });
    }

    function renderBarChart(records){
      const metric = el.metricSelect.value;
      const { latest, items } = aggregateByItemLatestMonth(records);
      const top = items.slice(0,10);

      const labels = top.map(x=>x.item);
      const values = top.map(x=>{
        if(metric==="usd") return x.usd;
        if(metric==="qty") return x.qty;
        if(metric==="unit") return x.unit;
        return x.usd;
      });

      const ctx = document.getElementById("barChart");
      if(barChart) barChart.destroy();
      barChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: `Top (${latest || "—"})`,
            data: values,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor: "end",
              align: "end",
              offset: 2,
              color: "#0b3d2e",
              font: { weight: "800", size: 10 },
              formatter: (v)=> {
                if(!isFinite(v)) return "";
                return datalabelFormatter(metric, v);
              }
            },
            tooltip: {
              callbacks: {
                label: (c) => {
                  const v = c.parsed.y;
                  if(metric==="usd" || metric==="unit") return ` ${fmtUSD(v)}`;
                  return ` ${fmtNum(v)}`;
                }
              }
            }
          },
          scales: {
            y: {
              ticks: { callback: (v) => (metric==="usd" || metric==="unit") ? fmtUSD(v) : fmtNum(v) },
              grid: { color: "rgba(2,6,23,.06)" }
            },
            x: { ticks: { maxRotation: 60, minRotation: 30 }, grid: { display:false } }
          }
        }
      });
    }

    function renderTable(records){
      const rows = [...records].sort((a,b)=>{
        const ka = `${a.month}||${a.quincena||""}||${a.category}||${a.item}||${a.file}`;
        const kb = `${b.month}||${b.quincena||""}||${b.category}||${b.item}||${b.file}`;
        return ka.localeCompare(kb);
      });

      el.tableBody.innerHTML = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.month)}</td>
          <td>${escapeHtml(quincenaLabel(r.quincena))}</td>
          <td>${escapeHtml(r.file)}</td>
          <td>${escapeHtml(r.category)}</td>
          <td>${escapeHtml(r.item)}</td>
          <td>${escapeHtml(r.undTarifaria)}</td>
          <td class="num">${fmtNum(r.qty)}</td>
          <td class="num">${fmtUnit(r.unit)}</td>
          <td class="num">${fmtUSD(r.usd)}</td>
        </tr>
      `).join("");

      el.badgeRows.textContent = `${rows.length} filas`;
    }

    function exportExcel(){
      const rec = filteredRecords();
      const agg = aggregateByMonth(rec);

      const detail = rec.map(r=>({
        Mes: r.month,
        Quincena: quincenaLabel(r.quincena),
        Archivo: r.file,
        Categoria: r.category,
        Descripcion: r.item,
        "UND Tarifaria": r.undTarifaria,
        Cantidad: r.qty,
        "Precio Unitario": r.unit,
        "Total USD": r.usd
      }));

      const resumen = agg.map(a=>({
        Mes: a.month,
        "Total USD": a.usd,
        Cantidad: a.qty,
        "Precio Unitario (ponderado)": a.unit
      }));

      const files = [...fileSummaries.values()].map(s=>({
        Estado: s.status==="ok" ? "OK" : "ERROR",
        Mes: s.month || "—",
        Quincena: quincenaLabel(s.quincena),
        Archivo: s.file,
        "Filas items": s.rows || 0,
        "Total USD": s.usd || 0,
        "Saldo adeudado": isFinite(s.saldo) ? s.saldo : ""
      }));

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(resumen), "Resumen_Mes");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detail), "Detalle");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(files), "Archivos");
      XLSX.writeFile(wb, "Dashboard_Servicios_Export.xlsx");
    }

    function renderKPIsAndCharts(){
      const rec = filteredRecords();
      const agg = aggregateByMonth(rec);
      const totalUSD = agg.reduce((s,a)=>s+a.usd,0);
      const totalQty = agg.reduce((s,a)=>s+a.qty,0);
      let uw=0, w=0;
      for(const r of rec){
        if(isFinite(r.unit) && r.unit>0 && isFinite(r.qty) && r.qty>0){
          uw += r.unit * r.qty;
          w += r.qty;
        }
      }
      const unit = w>0 ? (uw/w) : 0;

      el.kpiUSD.textContent = fmtUSD(totalUSD);
      el.kpiQty.textContent = fmtNum(totalQty);
      el.kpiUnit.textContent = fmtUSD(unit);

      const months = monthsSorted(allRecords);
      el.badgePeriod.textContent = months.length ? `${months[0]} → ${months[months.length-1]}` : "—";

      el.badgeItems.textContent = `${new Set(allRecords.map(r=>r.item)).size} items`;
      el.badgeMetric.textContent = el.metricSelect.value.toUpperCase();
      el.badgeFilter.textContent = (el.itemSelect.value === "__ALL__") ? "Todos" : el.itemSelect.value;

      const catLabel = activeCategory === "__ALL__"
        ? "Todos"
        : (CAT_ORDER.find(x=>x.key===activeCategory)?.label || activeCategory);
      el.badgeCat.textContent = catLabel;

      el.kpiUSDHint.textContent = `${agg.length} meses (según filtro)`;
      el.kpiQtyHint.textContent = `—`;
      el.kpiUnitHint.textContent = `Ponderado`;

      const ok = [...fileSummaries.values()].filter(s=>s.status==="ok");
      const saldoSum = ok.reduce((s,x)=> s + (isFinite(x.saldo) ? x.saldo : 0), 0);
      const monthsOk = [...new Set(ok.map(x=>x.month).filter(Boolean))].sort();
      el.kpiSaldo.textContent = fmtUSD(saldoSum);
      el.kpiSaldoHint.textContent = `${ok.length} archivos (global)`;
      el.badgeSaldoPeriod.textContent = monthsOk.length ? `${monthsOk[0]} → ${monthsOk[monthsOk.length-1]}` : "—";

      el.badgeMonthsChip.textContent = `${monthsOk.length} meses`;

      renderLineChart(rec);
      renderQuincenaChart();
      renderDonut(rec);
      renderBarChart(rec);
      renderTable(rec);
    }

    function refreshAll(){
      if(allRecords.length === 0){
        showEmpty();
        renderYearTabs();
        renderCatTabs();
        requestAnimationFrame(syncStickyOffsets);
        return;
      }
      showDashboard();
      renderYearTabs();
      renderCatTabs();
      refreshItemSelect();
      renderUploadsPanel();
      renderKPIsAndCharts();
      requestAnimationFrame(syncStickyOffsets);
    }

    function readFileAsArrayBuffer(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsArrayBuffer(file);
      });
    }

    function setProgress(show, done=0, total=0, name=""){
      el.progressPill.style.display = show ? "flex" : "none";
      if(show){
        el.progressText.textContent = name ? `Procesando: ${name}` : "Procesando archivos…";
        el.progressCount.textContent = `${done}/${total}`;
        const pct = total ? Math.round((done/total)*100) : 0;
        el.progressFill.style.width = `${pct}%`;
      }
    }

    async function handleFiles(fileList){
      const files = Array.from(fileList || []);
      if(!files.length) return;

      if(cloud.enabled && !cloud.isAdmin){
        toast("Modo visor", "Este link está en modo online. Para subir archivos, inicia sesión con una cuenta admin.");
        el.fileInput.value = "";
        return;
      }

      setProgress(true, 0, files.length, "");
      let done = 0;

      for(const file of files){
        try{
          setProgress(true, done, files.length, file.name);
          const buf = await readFileAsArrayBuffer(file);
          const wb = XLSX.read(buf, { type:"array", cellDates:true });
          const parsed = parseRecuadroFromWorkbook(wb, file.name);

          allRecords = allRecords.filter(r => r.file !== file.name);

          if(parsed.error){
            localFailures.set(file.name, parsed.error);
            fileSummaries.set(file.name, { ...(parsed.fileSummary || {file:file.name}), status:"fail", error: parsed.error });
          } else {
            localFailures.delete(file.name);
            allRecords = allRecords.concat(parsed.records);
            fileSummaries.set(file.name, { ...(parsed.fileSummary || {file:file.name}), status:"ok" });

            // Persistir en nube (1 doc por archivo)
            if(cloud.enabled && cloud.isAdmin){
              try{
                await upsertCloudUpload(file, parsed);
              }catch(e){
                toast("Firebase", "No se pudo guardar '" + file.name + "': " + (e?.message || e));
              }
            }
          }
        }catch(e){
          allRecords = allRecords.filter(r => r.file !== file.name);
          localFailures.set(file.name, "Error de lectura del archivo.");
          fileSummaries.set(file.name, { file:file.name, status:"fail", error:"Error de lectura del archivo.", month: parseMonthFromFilename(file.name), quincena: detectQuincena(file.name.toLowerCase()), saldo: NaN, rows:0, usd:0 });
        }

        done += 1;
        setProgress(true, done, files.length, "");
        await new Promise(r=>setTimeout(r,0));
      }

      el.fileInput.value = "";
      setProgress(false);
      refreshAll();
    }

    el.fileInput.addEventListener("change", (e)=> handleFiles(e.target.files));
    el.btnLogin.addEventListener("click", async ()=>{
      if(!cloud.enabled){
        toast("Firebase", "Pega tu firebaseConfig en el HTML (FIREBASE_CONFIG).");
        return;
      }

      // Validaciones rápidas para evitar el error (auth/operation-not-supported-in-this-environment)
      if(!isHttpProtocol()){
        toast("Login", "Abre este dashboard desde https:// (GitHub Pages) o http://localhost. No funciona si lo abres como archivo local (file://).");
        return;
      }
      if(!canUseWebStorage()){
        toast("Login", "Tu navegador está bloqueando el almacenamiento del sitio (cookies/almacenamiento). Permite cookies/almacenamiento para este dominio y vuelve a intentar.");
        return;
      }

      const provider = new firebase.auth.GoogleAuthProvider();

      try{
        await cloud.auth.signInWithPopup(provider);
      }catch(e){
        const code = e?.code || "";
        const msg  = (e?.message || String(e||"")).toLowerCase();

        if(code === "auth/operation-not-supported-in-this-environment" || msg.includes("operation-not-supported")){
          // Fallback más robusto: redirect
          try{
            await cloud.auth.signInWithRedirect(provider);
            toast("Login", "Redirigiendo a Google…");
          }catch(e2){
            toast("Login", e2?.message || e2);
          }
          return;
        }
        if(code === "auth/popup-blocked"){
          toast("Login", "Tu navegador bloqueó el popup. Habilita popups para este sitio o vuelve a intentar.");
          return;
        }
        if(code === "auth/unauthorized-domain"){
          toast("Login", "Dominio no autorizado. En Firebase Console → Authentication → Settings → Authorized domains, agrega: " + location.hostname);
          return;
        }
        toast("Login", e?.message || e);
      }
    });
    el.btnLogout.addEventListener("click", async ()=>{
      if(!cloud.enabled) return;
      try{ await cloud.auth.signOut(); }catch(e){ toast("Logout", e?.message || e); }
    });
    if(el.btnCloudPurge) el.btnCloudPurge.addEventListener("click", async ()=>{
      await purgeCloudUploads();
    });

    // Inicia sincronización online (si hay config pegada)
    initCloud();

    el.itemSelect.addEventListener("change", refreshAll);
    el.metricSelect.addEventListener("change", refreshAll);

    el.btnReset.addEventListener("click", ()=>{
      // Reset de vista (no borra la nube)
      activeCategory = "__ALL__";
      activeYear = "__ALL__";
      el.fileInput.value = "";
      el.itemSelect.value = "__ALL__";
      el.metricSelect.value = "usd";

      if(lineChart) { lineChart.destroy(); lineChart=null; }
      if(barChart) { barChart.destroy(); barChart=null; }
      if(donutChart) { donutChart.destroy(); donutChart=null; }
      if(qChart) { qChart.destroy(); qChart=null; }

      el.toast.style.display = "none";
      refreshAll();
    });

    el.btnExport.addEventListener("click", ()=>{
      if(allRecords.length === 0 && fileSummaries.size === 0){
        toast("Falta data", "Primero sube al menos 1 archivo.");
        return;
      }
      exportExcel();
    });
    renderYearTabs();
    renderCatTabs();
    showEmpty();
    syncStickyOffsets();
  </script>
</body>
</html>
